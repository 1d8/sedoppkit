import requests
import json
from modules.misc import ExploitClass

def findExploit(softwareName):
    headers = {
        "Host": "www.exploit-db.com",
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0",
        "Accept": "application/json, text/javascript, */*; q=0.01",
        "Accept-Language": "en-US,en;q=0.5",
        "Accept-Encoding": "gzip, deflate, br",
        "Referer": "https://www.exploit-db.com/",
        "X-Requested-With": "XMLHttpRequest",
        "DNT": "1",
        "Connection": "keep-alive",
        "Cookie": "XSRF-TOKEN=eyJpdiI6InBGaFA5QUxKOFFOTkRRU1ZoeDI5Vmc9PSIsInZhbHVlIjoibHBuUXlNQ0tqeGd5S0tPdHFuZmxuNGdSTVhWZGh3NWVXZlwvempVSHJVdW5wQTk0M1ZRZ0x1U3l6ayswckltbEMiLCJtYWMiOiI1ZjEyMjc2MjVhZmRiNmRiZWJhNmM4YmYwNzM2MDYxMjlmYzFhZDA4OGQxYzM5MDdiMjgzMmIwNDMzMjU5NGMxIn0%3D; exploit_database_session=eyJpdiI6InRSUExDTmk5dHdXdlRVa2pBVUtReUE9PSIsInZhbHVlIjoiNmNHNVE1YWs5c0k5NlNzU0F5Qks0OWM5NnIyV3hxcVVtampBaHNpeCs0dkRGcVZ1NnRLem9WRnNuR1UyOFwvV1ciLCJtYWMiOiIyMTYzYjA3NDdiM2QzYmQyMTU2NmE1N2UyYTIxODFjZWIzMzg1ZWQyNDNhMDU3OGQyOGYwOTk4NTBjYjQ3M2NmIn0%3D; CookieConsent={stamp:%27Pca6ktf2lJlyO7kS6SFuCutIhduX0/oXu0QEdJpbrFYdPr7TvTYAsg==%27%2Cnecessary:true%2Cpreferences:false%2Cstatistics:false%2Cmarketing:false%2Cver:1%2Cutc:1617579810927%2Cregion:%27us-06%27}",
        "Sec-GPC": "1",
        "TE": "Trailers"
    }
    url = "https://www.exploit-db.com/?draw=10&columns[0][data]=date_published&columns[0][name]=date_published&columns[0][searchable]=true&columns[0][orderable]=true&columns[0][search][value]=&columns[0][search][regex]=false&columns[1][data]=download&columns[1][name]=download&columns[1][searchable]=false&columns[1][orderable]=false&columns[1][search][value]=&columns[1][search][regex]=false&columns[2][data]=application_md5&columns[2][name]=application_md5&columns[2][searchable]=true&columns[2][orderable]=false&columns[2][search][value]=&columns[2][search][regex]=false&columns[3][data]=verified&columns[3][name]=verified&columns[3][searchable]=true&columns[3][orderable]=false&columns[3][search][value]=&columns[3][search][regex]=false&columns[4][data]=description&columns[4][name]=description&columns[4][searchable]=true&columns[4][orderable]=false&columns[4][search][value]=&columns[4][search][regex]=false&columns[5][data]=type_id&columns[5][name]=type_id&columns[5][searchable]=true&columns[5][orderable]=false&columns[5][search][value]=&columns[5][search][regex]=false&columns[6][data]=platform_id&columns[6][name]=platform_id&columns[6][searchable]=true&columns[6][orderable]=false&columns[6][search][value]=&columns[6][search][regex]=false&columns[7][data]=author_id&columns[7][name]=author_id&columns[7][searchable]=false&columns[7][orderable]=false&columns[7][search][value]=&columns[7][search][regex]=false&columns[8][data]=code&columns[8][name]=code.code&columns[8][searchable]=true&columns[8][orderable]=true&columns[8][search][value]=&columns[8][search][regex]=false&columns[9][data]=id&columns[9][name]=id&columns[9][searchable]=false&columns[9][orderable]=true&columns[9][search][value]=&columns[9][search][regex]=false&order[0][column]=9&order[0][dir]=desc&start=0&length=120&search[value]={0}&search[regex]=false&author=&port=&type=&tag=&platform=&_=1617579804259".format(softwareName)
    response = requests.get(url, headers=headers)
    responseJson = response.json()
    if len(responseJson["data"]) == 0: #Indicates no results returned
        return "None"
    else:
        exploitList = []
        for i in responseJson["data"]:
            exploit = ExploitClass.ExploitClass(i["id"], i["description"][1], i["type_id"], i["platform_id"], i["date_published"], i["verified"])
            exploitList.append(exploit)
        return exploitList

def getCode(exploitID):
    headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"}
    url = "https://www.exploit-db.com/raw/{0}".format(exploitID)
    response = requests.get(url, headers=headers)
    if response.status_code == 404:
        return "Not found"
    else:
        return response.text



